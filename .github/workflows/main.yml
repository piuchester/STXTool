name: Cloud Build Rust
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Clean and Patch Dependencies
        shell: pwsh
        run: |
          # 1. Limpa qualquer configuração de Git residual de tentativas anteriores
          git config --global --unset-all url.https://github.com/.insteadOf || $true
          git config --global --unset-all url.ssh://git@github.com/.insteadOf || $true
          
          # 2. Lê o arquivo Cargo.toml
          $toml = Get-Content Cargo.toml -Raw
          
          # 3. Substitui os links mortos por mirrors da comunidade (pizofreude)
          $toml = $toml -replace 'ssh://git@github.com/StepMania-AMX/libamx.git', 'https://github.com/pizofreude/libamx.git'
          $toml = $toml -replace 'ssh://git@github.com/StepMania-AMX/stx.git', 'https://github.com/pizofreude/stx.git'
          
          # 4. REMOVE a trava de 'rev' (commit específico). 
          # Isso força o Rust a pegar o código mais atual do mirror, evitando erro de "revision not found"
          $toml = $toml -replace ', rev = "[a-z0-9]+"', ''
          
          # 5. Salva o arquivo atualizado
          $toml | Set-Content Cargo.toml
          Write-Host "Cargo.toml atualizado com novos mirrors e sem travas de versão."

      - name: Build STXTool
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: true
        run: cargo build --release

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: STXTool-Windows
          path: target/release/stxtool.exe
